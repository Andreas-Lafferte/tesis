# Resultados {#application}
<div style="text-align: justify">

```{r database, message=TRUE, warning=TRUE, include=FALSE, paged.print=TRUE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, sjmisc, kableExtra, sjPlot,
               summarytools, DT, lme4, easystats, gtsummary, 
               stargazer, magrittr, htmlTable, gridExtra,
               influence.ME, janitor, lessR, ggrepel, ggpubr,
               performance, ggrepel, ggthemes, flexplot,
               sjlabelled, RColorBrewer, stats, car, texreg)

options(scipen=999)

load("../output/data/db-proc.RData")
load("../output/data/df2-proc.RData")

names(db)

```


## Descriptivos
<div style="text-align: justify">

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum Tabla \@ref(tab:tab-desc1)


```{r include=FALSE}
reset_gtsummary_theme()
theme_gtsummary_compact(set_theme = T)
theme_gtsummary_language(language = "es", decimal.mark = ".", big.mark = ",", set_theme = T)

```


```{r tab-desc1, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
         
options(kableExtra.html.bsTable = T)
options(knitr.kable.NA = '')


tab1 <- db %>% select(PSCi, CLASS, UNION, AGE, SEX, IDEOLOGY) %>% 
  gtsummary::tbl_summary(
                         missing = "no",
                         type = list(all_continuous()~ 'continuous2'),
                         statistic = all_continuous() ~ c("{mean} ({sd})", 
                                                          "{min}, {max}")) %>% 
  add_n(last = F, statistic = "{N_nonmiss}") %>% 
  bold_labels(.) %>% 
  modify_spanning_header(all_stat_cols() ~ "**Valores**") %>%
  modify_footnote(update = all_stat_cols() ~ "Media (DE); Rango (Min, Max); Frecuencia (%)") %>% 
  modify_header(update = list(label ~ "**Variable**")) %>% 
  modify_caption("Estadísticos descriptivos de nivel individual") %>% 
  gtsummary::as_kable_extra(strip_md_bold = T) %>%
  kableExtra::kable_styling(latex_options = "hold_position", font_size = 14, position = "center") %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = T) %>% 
  kableExtra::row_spec(row = c(1,4,14,17,20,23),bold = T) %>% 
  kableExtra::add_footnote(label = "Fuente: Elaboración propia en base a ISSP 1999-2019. Datos no ponderados")

tab1
```


Descripción de distribución de frecuencias para la posición de clase y la afiliación sindical, comenzando con los totales y luego mencionando su estabilidad en entre los años. Ejemplo: Tabla \@ref(tab:tab-desc2)

A nivel individual, la Tabla 3.1. muestra una clara tendencia en la distribución de las frecuencias de la posición de clase: la gran mayoría de los individuos -más de un tercio de la muestra- se ubican en la posición de clase trabajadora no calificada (34%). A esta categoría le siguen la clase de trabajadores calificados (18%) y la pequeña burguesía (15%). Luego, se encuentran las posiciones asociadas típicamente a las clases medias siguiendo un orden descendente: supervisores calificados (10%), expertos sin autoridad (6.9%) y expertos directivos (5.4%). Por su parte, la clase de supervisores no calificados, que se asocia comúnmente a posiciones de clase trabajadora, es minoritaria respecto a las posiciones de clases medias pues solo alcanza a concentrar un 5.6% del total de los casos. Finalmente, las posiciones de clase minoritarias corresponden a la de los pequeños empleadores y a la de los capitalistas o grandes propietarios, con un 3.5% y un 1.2% de los casos respectivamente. Observando la distribución de esta variable en el tiempo se puede notar un patrón estable al recién descrito, con la excepción del año 2019 en donde la proporción de individuos pertenecientes a la pequeña burguesía supera en 4 puntos porcentuales a la proporción de individuos de la clase de trabajadores calificados (14%). En cuanto a la afiliación sindical, se puede concluir que la mayoría de los individuos de la muestra no forman parte de alguna organización sindical (60%) en comparación a quienes sí son miembros o han estado afiliados a sindicatos (40%). Tal distribución se repite en los años 1999 y 2019, en donde casi tres quintas partes de los encuestados no forman parte de organizaciones sindicales, mientras que para el año 2009 esta diferencia se reduce levemente en cerca de un 10%. 


Se finaliza mencionando la descripción de datos de las variables de control: edad, sexo, identificación política e identidad de clase.

```{r tab-desc2, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

tab2 <- df %>% select(RATIO_IC, CorpAll, GDP, SOC_EXPEND, UD) %>% 
  gtsummary::tbl_summary(
                         missing = "no",
                         type = list(all_continuous()~ 'continuous2'),
                         statistic = all_continuous() ~ c("{mean} ({sd})", 
                                                          "{min}, {max}")) %>% 
  add_n(last = F, statistic = "{N_nonmiss}") %>% 
  bold_labels(.) %>% 
  modify_spanning_header(all_stat_cols() ~ "**Valores**") %>%
  modify_footnote(update = all_stat_cols() ~ "Media (DE); Rango (Min, Max)") %>% 
  modify_header(update = list(label ~ "**Variable**")) %>% 
  modify_caption("Estadísticos descriptivos de nivel contextual") %>% 
   gtsummary::as_kable_extra(strip_md_bold = T) %>%
  kableExtra::kable_styling(latex_options = "hold_position", font_size = 14, position = "center") %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = T) %>% 
  kableExtra::row_spec(row = c(1,4,7,10,13),bold = T) %>% 
  kableExtra::add_footnote(label = "Fuente: Elaboración propia en base a WIID, ICTWSS y OCDE")

tab2
```



Se sigue con la Tabla 2 que muestra los estadísticos descriptivos de nivel individual, mencionando los valores promedios totales para el Ratio 80/20 y para el índice de corporativismo. Tambíen se mencionan la alta variación en los datos materializado en una alta desviación estandar para estos indicadores, ejemplificando con los valores mínimos y máximos. 

Se termina mencionando las variables de control de nivel 2: GDP, gasto social y densidad sindical. 

Una de las primeras preguntas que deben ir siendo respondidas antes de realizar estimaciones multinivel es si, al menos descriptivamente, el nivel de conflicto percibido tiende a varíar entre las unidades de nivel contextual, esto es, los países. El gráfico 2 busca representar lo anterior mostrando la evolución del promedio de PSCi para cada país a través del tiempo. Aquí se describe el grafico con una interpretación general de la tendencia y enfocandose en países especificos.


```{r fig4, echo=FALSE, fig.asp=1.5, out.width='80%', message=FALSE, warning=FALSE, fig.align='default', fig.cap="(ref:fig4)" }

my_colors <- RColorBrewer::brewer.pal(10, "Blues")[8]

formatter <- function(...){
  function(x) format(round(x, 1), ...)
}

fig4 <- db %>% group_by(COUNTRY, YEAR) %>% 
  summarise(promedio = round(mean(PSCi), digits = 1)) %>% 
  ggplot(aes(x = YEAR, y = promedio)) +
  geom_line(colour = my_colors) + 
  geom_point(colour = my_colors)+
  scale_x_continuous(breaks=seq(1999, 2019, 10)) +
  facet_wrap(.~COUNTRY, ncol = 5, scales = "fixed") + # for thesis uses 8 in ncol and free_y in scales
  scale_y_continuous(labels = formatter(nsmall = 1)) +
  geom_hline(aes(yintercept = 3.9), linetype = "dashed", color = "gray40") +
  theme_classic() + # and classic theme
  labs(x = "Año", 
       y = "Promedio PSCi", 
       title = "Evolución percepciones de conflicto social entre 1999 y 2019") +
  theme(plot.title = element_text(size = 12), 
        axis.title = element_text(size = 11),
        plot.caption = element_text(size = 10))


fig4
```

(ref:fig4) Evolución percepciones de conflicto social entre 1999-2019. Datos no ponderados. Fuente: Elaboración propia en base a [ISSP (1999-2019)](https://www.gesis.org/en/issp/modules/issp-modules-by-topic/social-inequality).


En cuanto a la asociación entre variables, las tablas 3 y 4 nos muestran el promedio de PSCi para la posición de clase y la afiliación sindical, respectivamente. Aqui se describe la asociación entre cada categoría de clase y el promedio de PSCi, así como el test de ANOVA para conocer si existen difererencias significativas entre las categorías de clase. (ver Figura \@ref(fig:fig4))



```{r tab-bi1, echo=FALSE, message=FALSE, warning=FALSE}

tot1 <- db %>% select(PSCi, CLASS, FACTOR) %>% 
  filter(!is.na(PSCi)&!is.na(CLASS)) %>% 
  group_by(CLASS) %>% 
  summarise(total = weighted.mean(x = PSCi, w = FACTOR, na.rm = T)) %>% 
  mutate(total = round(total, digits = 2))

biva1 <- db %>% select(PSCi, CLASS, YEAR, FACTOR) %>% 
  filter(!is.na(PSCi)&!is.na(CLASS)) %>% 
  mutate(YEAR = as_factor(YEAR)) %>% 
  group_by(YEAR, CLASS) %>% 
  summarise(promedio = weighted.mean(x = PSCi, w = FACTOR, na.rm = T)) %>% 
  mutate(promedio = round(promedio, digits = 2)) %>% 
  pivot_wider(names_from = YEAR, values_from = c(promedio)) %>% 
  add_column(tot1[2]) %>% 
  knitr::kable(format = "html", row.names = F, col.names = c("Posición de clase", "1999", "2009", "2019", "Total"), caption = "Promedio PSCi por categoría de clase según año") %>% kableExtra::kable_styling(latex_options = "hold_position", font_size = 14, position = "center") %>% 
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F) %>% 
  add_header_above(c("Variable independiente" = 1, "Año" = 4)) %>% 
  kableExtra::column_spec(1, width = "9.85cm") %>%
  kableExtra::column_spec(2, width = "6.85cm") %>% 
  kableExtra::footnote(
           number = c(""),
           general_title = "F=83.50  df=8  Cohen's f=0.129  p=0.000 ", number_title = "F=83.50  df=8  Cohen's f=0.129  p=0.000 ",
           footnote_as_chunk = T, title_format = c("italic")
           )
biva1

```





Aquí se describe la asociación de la condición de afiliación sindical y el promedio de PSCi, indicando si existen diferencias significativas entre quienes están afiliados y quienes no.


```{r tab-bi2, echo=FALSE, message=FALSE, warning=FALSE}

tot2 <- db %>% select(PSCi, UNION, FACTOR) %>% 
  filter(!is.na(PSCi)&!is.na(UNION)) %>% 
  group_by(UNION) %>% 
  summarise(total = weighted.mean(x = PSCi, w = FACTOR, na.rm = T)) %>% 
  mutate(total = round(total, digits = 2))


biva2 <- db %>% select(PSCi, UNION, YEAR, FACTOR) %>% 
  filter(!is.na(PSCi)&!is.na(UNION)) %>% 
  mutate(YEAR = as_factor(YEAR)) %>% 
  group_by(YEAR, UNION) %>% 
  summarise(promedio = weighted.mean(x = PSCi, w = FACTOR, na.rm = T)) %>% 
  mutate(promedio = round(promedio, digits = 2)) %>% 
  pivot_wider(names_from = YEAR, values_from = promedio) %>% 
  add_column(tot2[2]) %>% 
  knitr::kable(format = "html", row.names = F, col.names = c("Afiliación sindical", "1999", "2009", "2019", "Total"), caption = "Promedio PSCi por afiliación sindical según año") %>% kableExtra::kable_styling(latex_options = "hold_position", font_size = 14, position = "center") %>% 
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F) %>% 
  add_header_above(c("Variable dependiente" = 1, "Año" = 4)) %>% 
  kableExtra::column_spec(1, width = "9.85cm") %>%
  kableExtra::column_spec(2, width = "6.85cm") %>% 
  kableExtra::footnote(
           number = c(""),
           general_title = "F=259.45  df=1  Cohen's f=0.081  p=0.000 ", number_title = "F=259.45  df=1  Cohen's f=0.081  p=0.000 ",
           footnote_as_chunk = T, title_format = c("italic")
           )

biva2
```



Ahora pasamos a la sección bivariada de nivel contextual. Primero se comienza describiendo la asociación y valor del coef de correlación entre el Ratio 80/20 y el promedio de PSCi por país y año, tal como se muestra en el grafico 3. Se detalla tambien el grado en que los datos(países) se ajustan a la estimación de la recta pues hay países como Sudafrica que figuran como casos extremos. 




```{r fig5, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.asp=0.8, out.width='80%', fig.align='default', fig.cap="(ref:fig5)"}

dat_text <- data.frame(
  label = c("R = 0.71", "R = 0.26", "R = 0.51"),
  YEAR   = c("1999", "2009", "2019"),
  PSCi = c(1.5, 1.5, 1.5),
  RATIO_IC = c(35,35,35))


fig5 <- db %>% select(ISO_COUNTRY, YEAR, PSCi, RATIO_IC) %>% 
  na.omit() %>% 
  group_by(ISO_COUNTRY, YEAR) %>% 
  summarise_all(mean, na.rm = T) %>% 
  ggplot(aes(x = RATIO_IC, y = PSCi, label = ISO_COUNTRY)) +
  geom_point(size = 1.5, alpha = 0.8, colour = my_colors) +
  geom_smooth(stat = "smooth", position = "identity", method = "lm", 
              colour = "#1f1f1f", size = 1) +
  geom_text_repel(aes(label=ISO_COUNTRY), size=2.5, show.legend = FALSE, colour = my_colors) + 
  facet_wrap(.~YEAR, scales = "fixed") +
  scale_y_continuous("Promedio PSCi", limits = c(1, 7),
                     breaks = seq(1, 7, 1),
                     labels = formatter(nsmall = 1)) +
  scale_x_continuous("Ratio S80/S20", limits = c(0, 45),
                     breaks = seq(0, 45, 10)) +
  labs(x = "Ratio S80/S20", 
       y = "Promedio PSCi", 
       title = "Promedio de conflicto social percibido y Ratio 80/20 por país y año") +
  theme(plot.title = element_text(size = 12), 
        axis.title = element_text(size = 11),
        plot.caption = element_text(size = 10))+
  theme_classic() +
  geom_text(data = dat_text,
            mapping = aes(x = RATIO_IC, y = PSCi, label = label))

fig5
```

(ref:fig5) Promedio de conflicto social percibido y Ratio 80/20 por país y año. Datos no ponderados. Fuente: Elaboración propia en base a [ISSP (1999-2019)](https://www.gesis.org/en/issp/modules/issp-modules-by-topic/social-inequality) y [WIID](https://www.wider.unu.edu/database/world-income-inequality-database-wiid#WIIDcomp).



Se finaliza con la descripción de la asociación y del coef de correlación entre el grado de corporativismo de los países y su nivel promedio de PSCi según año, indicando nuevamente cómo se dsitribuyen los casos en torno a la recta. 




```{r fig6, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.asp=0.8, out.width='80%', fig.align='default', fig.cap="(ref:fig6)"}

dat_text2 <- data.frame(
  label = c("R = -0.55", "R = -0.12", "R = -0.04"),
  YEAR   = c("1999", "2009", "2019"),
  PSCi = c(1.5, 1.5, 1.5),
  CorpAll = c(1.0,1.0,1.0))


fig6 <- db %>% select(ISO_COUNTRY, YEAR, PSCi, CorpAll) %>% 
  na.omit() %>% 
  group_by(ISO_COUNTRY, YEAR) %>% 
  summarise_all(mean, na.rm = T) %>% 
  ggplot(aes(x = CorpAll, y = PSCi, label = ISO_COUNTRY)) +
  geom_point(size = 1.5, alpha = 0.8, colour = my_colors) +
  geom_smooth(stat = "smooth", position = "identity", method = "lm", 
              colour = "#1f1f1f", size = 1) +
  geom_text_repel(aes(label=ISO_COUNTRY), size=2.5, show.legend = FALSE, colour = my_colors) + 
  facet_wrap(.~YEAR, scales = "fixed") +
  scale_y_continuous("Promedio PSCi", limits = c(1, 7),
                     breaks = seq(1, 7, 1),
                     labels = formatter(nsmall = 1)) +
  scale_x_continuous("Índice Corporativismo", limits = c(-1.5, 1.5),
                     breaks = seq(-1.5, 1.5, 0.5)) +
  labs(x = "Índice Corporativismo", 
       y = "Promedio PSCi", 
       title = "Promedio de conflicto social percibido y nivel de corporativismo por país y año", 
       caption = " Fuente: Elaboración propia en base a ISSP 1999-2019") +
  theme(plot.title = element_text(size = 12), 
        axis.title = element_text(size = 11),
        plot.caption = element_text(size = 10))+
  theme_classic() +
  geom_text(data = dat_text2,
            mapping = aes(x = CorpAll, y = PSCi, label = label))

fig6
```

(ref:fig6) Promedio de conflicto social percibido y nivel de corporativismo por país y año. Datos no ponderados. Fuente: Elaboración propia en base a [ISSP (1999-2019)](https://www.gesis.org/en/issp/modules/issp-modules-by-topic/social-inequality) e [ICTWSS](https://www.ictwss.org/).


## Modelos
<div style="text-align: justify">

En esta sección se presentan los resultados de los modelos multinivel para los 33 países bajo estudio entre los años 1999, 2009 y 2019. Con el fin de facilitar el contraste de hipótesis, esta sección se subdivide en cinco apartados. Primero, y como es usual, se comienza estimando un modelo nulo o de base en el que se descompone la varianza de PSCi a nivel individual y contextual con el propósito de conocer si el conflicto percibido varía entre países (Hox, et al., 2017). Segundo, se estiman modelos con interceptos aleatorios incluyendo los predictores de nivel individual tanto de hipótesis como de control. Tercero, se realiza la misma estimación anterior pero ahora incluyendo los predictores de nivel contextual. Cuarto, se presentan los análisis de los modelos con pendiente aleatoria e interacción entre niveles mediante un gráfico de valores predichos. Por último, se presentan los estadísticos de bondad de ajuste de los modelos a través de pruebas de razón de verosimilitud y se cierra con un resumen de los principales hallazgos.

De acuerdo con la Tabla 3.4, la correlación intraclase para el modelo nulo es igual a 0.217 (ICC =[0.913/(0.913+3.294)]), lo cual indica la cantidad de varianza de PSCi que puede atribuirse a la estructura de agrupación en la población, en este caso, los países (Hox et al., 2017). Esto significa que cerca de un 22% de la varianza total del conflicto percibido en los individuos se asocia a características específicas de los países, asentando como precedente que existen diferencias significativas entre estos respecto al nivel de conflicto social percibido. 



```{r, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Null model
model_0 <- lmer(PSCi ~ 1 + (1 | COUNTRY), 
                data = db, weights = FACTOR, REML = T)

performance::icc(model_0, by_group = T)
## ICC Country = 0.217
## ICC Individual = 0.783


# Influence test
inf_m0 <- influence(model_0, group = "COUNTRY")

# D cook
cooks.distance(inf_m0) # cut point is 4/33 = 0.1212121

plot(inf_m0, which="cook",
     cutoff=0.121, sort=TRUE,
     xlab="Distancia de Cook",
     ylab="País", width=60, height=40)

# Influential countries: South Korea and Hungary. 
# The first two are the two with the highest average PSCi.


# Model 1: Only Class
model_1 <- lmer(PSCi ~ 1 + CLASS +
                  (1 | COUNTRY), data = db, weights = FACTOR, REML = T)

# Model 2: Class + Union
model_2 <- lmer(PSCi ~ 1 + CLASS + UNION +
                  (1 | COUNTRY), data = db, weights = FACTOR, REML = T)

# Model 3: Class + Union + Controls N1
model_3 <- lmer(PSCi ~ 1 + CLASS + UNION + AGE + SEX + relevel(IDEOLOGY,ref="Derecha") + 
                  (1 | COUNTRY), data = db, weights = FACTOR, REML = T)

# Model 4: Individual predictors + RATIO + CorpAll 
model_4 <- lmer(PSCi ~ 1 + CLASS + UNION + AGE + SEX + relevel(IDEOLOGY,ref="Derecha") + 
                  C_RATIO + CorpAll + WAVE +
                  (1 | COUNTRY), data = db, weights = FACTOR, REML = T)

# Model 5: Individual + Contextual + Controls N1 and N2
model_5 <- lmer(PSCi ~ 1 + CLASS + UNION + AGE + SEX + relevel(IDEOLOGY,ref="Derecha") + 
                    C_RATIO + CorpAll + C_GDP + C_SOCEXPEND +C_UD +
                    WAVE + 
                    (1 | COUNTRY), data = db, weights = FACTOR, REML = T)
                  

```




```{r model, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
tabmodel <- htmlreg(l = list(model_0, model_2, model_3, model_4, model_5),dcolumn = TRUE , type = "html", doctype = FALSE, digits = 2,caption = "**Tabla 3.4.** Modelos multinivel con interceptos aleatorios para 33 países entre 1999-2019", label = "tab:model", caption.above = T )

tabmodel
```



### Determinantes de nivel individual


### Determinantes de nivel contextual


### Interacción entre niveles


### Ajuste global y resumen de hallazgos





# Discusión {#discussion}
<div style="text-align: justify">
